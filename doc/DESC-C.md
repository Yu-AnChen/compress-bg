# Entropy-Based Tissue Segmentation and Background Suppression for Multiplexed Whole-Slide OME-TIFF Images

## 1. Introduction

This document describes the computational pipeline implemented in `compress_bg` for automated tissue detection and background suppression in large-scale, multi-channel whole-slide microscopy images stored in the OME-TIFF pyramidal format. The method leverages local Shannon entropy as a texture discriminator, combined with adaptive thresholding and morphological post-processing, to produce a binary tissue mask. The mask is subsequently applied at full resolution to zero out non-tissue regions, yielding a compressed output suitable for downstream analysis and archival storage.

## 2. Method

### 2.1 Thumbnail Extraction

Given an input pyramidal OME-TIFF image with _L_ resolution levels and _C_ channels, a low-resolution thumbnail is extracted from a user-specified pyramid level _l_ and channel index _c_. If the requested level exceeds the number of available levels, the deepest available level is used and further spatially subsampled by a factor of _d_^(_l_ - _l_'), where _d_ is the inter-level downscale factor (default _d_ = 2) and _l_' is the actual level read. This yields a 2D grayscale thumbnail image **T** of manageable size for subsequent analysis.

### 2.2 Intensity Pre-processing

The thumbnail undergoes a logarithmic transformation to compress the dynamic range:

> **T**' = log(1 + **T**)

Prior to entropy computation, pixel values are clipped from below at the minimum nonzero intensity to suppress instrumentation noise at the zero floor. The clipped image is then rescaled to the integer range [0, 1023] to serve as input to the entropy filter.

### 2.3 Local Entropy Computation

A local Shannon entropy map **E** is computed over the rescaled log-transformed thumbnail using a rank-order entropy filter with a square kernel of side length _k_ (default _k_ = 5 pixels). For each pixel, the entropy is evaluated over the discrete intensity histogram within the local neighborhood:

> _H_ = -sum( _p_(_i_) log_2 _p_(_i_) )

where _p_(_i_) denotes the empirical probability of intensity bin _i_ within the kernel window. Tissue regions, which exhibit heterogeneous texture, produce elevated entropy values relative to the comparatively uniform background.

### 2.4 Adaptive Multi-Level Thresholding

A base threshold _t_* is determined via Otsu's method applied to the entropy map **E**. To ensure robustness against pathological intensity distributions, _t_* is clamped to the interval [_E_min + 0.1 _R_, _E_max - 0.1 _R_], where _R_ = _E_max - _E_min is the entropy range. This prevents the threshold from collapsing to extreme values.

A user-adjustable center offset _alpha_ (default _alpha_ = 0.5, where _alpha_ = 0 corresponds to the unmodified Otsu threshold) shifts the base threshold:

> _t_ = _t_* + _alpha_ * _R_

The parameter _alpha_ is itself dynamically clipped to ensure the adjusted threshold remains within the 10th-to-90th percentile bounds of the entropy range.

Five candidate thresholds {_t__{-2}, _t__{-1}, _t_0, _t_1, _t_2} are then generated by uniformly partitioning the entropy range into two segments -- [_E_min, _t_] and [_t_, _E_max] -- each subdivided into three intervals, yielding three thresholds below and two above the center (five total). A discrete level-adjust index _j_ in {-2, -1, 0, 1, 2} selects the final operating threshold.

### 2.5 Mask Generation Pipeline

For each candidate threshold _t_j, a binary tissue mask **M**_j is constructed through the following sequential morphological pipeline:

1. **Entropy thresholding.** Initialize the mask as **M** = {**E** > _t_j}, identifying pixels whose local entropy exceeds the threshold.

2. **Intensity augmentation.** Compute the 25th percentile intensity _q_25 of **T**' restricted to the current foreground region **M**. Expand the mask to include all pixels satisfying **T**' >= _q_25. This step recovers tissue regions that may exhibit low textural complexity but high absolute signal (e.g., densely stained homogeneous tissue).

3. **Morphological dilation.** Dilate the mask with a disk-shaped structuring element of radius _r_ (default _r_ = 5 pixels at the thumbnail scale) to bridge narrow gaps between adjacent tissue fragments.

4. **Hole filling.** Apply binary flood-fill to eliminate enclosed background voids within contiguous tissue regions.

5. **Small object removal.** Discard connected components with area less than 4 times the area of the dilation footprint, suppressing spurious isolated detections.

### 2.6 Mask Selection and Coverage Bypass

The mask corresponding to the user-selected level-adjust index is chosen as the final tissue mask. As a safeguard, if the selected mask covers more than 90% of the thumbnail area, the mask is set to all-true (i.e., no background suppression is applied), under the assumption that the specimen occupies substantially the entire field of view.

### 2.7 Full-Resolution Masking and Output

The binary tissue mask, generated at the thumbnail resolution, is upscaled to the full-resolution image dimensions via nearest-neighbor replication by a factor of _d_^_l_. The upscaled mask is stored as a chunked Zarr array (chunk size 1024) to enable memory-efficient, block-wise processing of arbitrarily large images.

The masked output is computed as the element-wise product of the original multi-channel image and the binary mask:

> **I**_out = **I**_in * **M**_full

where the multiplication broadcasts the 2D mask across all _C_ channels. The result is written as a new pyramidal OME-TIFF file with zlib compression (tile size 1024), preserving the original pixel data type, pixel size metadata, OME-XML annotations, and TIFF tags (photometric interpretation, resolution, resolution unit, software provenance).

### 2.8 Quality Control Visualization

An optional diagnostic figure is produced comprising two panels:

- **Panel A**: The log-transformed thumbnail overlaid with a white contour delineating the selected tissue mask boundary.
- **Panel B**: The log-transformed thumbnail overlaid with a filled contour map showing the cumulative coverage of all five candidate masks (rendered using a diverging colormap), with the selected threshold level highlighted. An inset colorbar maps the entropy axis to the five discrete threshold levels.

## 3. Implementation Notes

- The pipeline is implemented in Python, utilizing NumPy, SciPy, scikit-image, Dask, Zarr, tifffile, and palom for OME-TIFF I/O and pyramid construction.
- Dask arrays enable lazy, out-of-core computation for full-resolution masking, avoiding memory constraints for gigapixel-scale images.
- Batch processing is supported via a CSV-driven interface, where each row parameterizes an independent processing job.
- All processing parameters are exposed through a command-line interface built with Python Fire.

## 4. Parameter Summary

| Parameter | Symbol | Default | Description |
|---|---|---|---|
| `channel` | _c_ | 0 | Image channel used for mask generation |
| `thumbnail_level` | _l_ | 6 | Pyramid level for thumbnail extraction |
| `img_pyramid_downscale_factor` | _d_ | 2 | Inter-level spatial downscale factor |
| `entropy_kernel_size` | _k_ | 5 | Side length of the entropy filter kernel (pixels) |
| `dilation_radius` | _r_ | 5 | Radius of the morphological dilation disk (pixels) |
| `level_center` | _alpha_ | 0.5 | Normalized offset from the Otsu threshold |
| `level_adjust` | _j_ | 0 | Discrete threshold selection index in {-2,...,2} |
